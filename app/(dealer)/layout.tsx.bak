"use client";

import {
  ReactNode,
  useEffect,
  useState,
  createContext,
  useContext,
} from "react";
import { createClient } from "@/utils/supabase/client";
import { useSearchParams } from "next/navigation";
import DealerNav from "@/components/DealerNav";
import I18nProvider, { useI18n } from "@/lib/i18n/I18nProvider";
import { ThemeProvider } from "@/lib/theme/ThemeContext";
import RecentActivityPanel from "@/components/RecentActivityPanel";
import { usePathname } from "next/navigation";
import { DealerProvider } from "./DealerContext";

type Dealer = {
  dealer_id: number;
  login_nr: string;
  store_name: string | null;
  company_name?: string | null;
  address?: string | null;
  zip?: string | null;
  city?: string | null;
  email?: string | null;
  phone?: string | null;
};



function DealerContent({ children }: { children: ReactNode }) {
  const supabase = createClient();
  const { t } = useI18n();
  const searchParams = useSearchParams();

  const [dealer, setDealer] = useState<Dealer | null>(null);
  const [loading, setLoading] = useState(true);
  const pathname = usePathname();

  useEffect(() => {
    (async () => {
      setLoading(true);

      const dealerIdParam = searchParams.get("dealer_id");

      if (dealerIdParam) {
        const { data: dealerRow, error } = await supabase
          .from("dealers")
          .select("*")
          .eq("dealer_id", Number(dealerIdParam))
          .single();

        if (!error && dealerRow) {
          setDealer({
            dealer_id: dealerRow.dealer_id,
            login_nr: dealerRow.login_nr,
            store_name: dealerRow.store_name,
            company_name: dealerRow.company_name,
            address: dealerRow.address,
            zip: dealerRow.plz ?? dealerRow.zip,
            city: dealerRow.city,
            email: dealerRow.email,
            phone: dealerRow.phone,
          });
          setLoading(false);
          return;
        }
      }

      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (user?.user_metadata?.login_nr) {
        const { data: dealerRow } = await supabase
          .from("dealers")
          .select("*")
          .eq("login_nr", user.user_metadata.login_nr)
          .single();

        if (dealerRow) {
          setDealer({
            dealer_id: dealerRow.dealer_id,
            login_nr: dealerRow.login_nr,
            store_name: dealerRow.store_name,
            company_name: dealerRow.company_name,
            address: dealerRow.address,
            zip: dealerRow.plz ?? dealerRow.zip,
            city: dealerRow.city,
            email: dealerRow.email,
            phone: dealerRow.phone,
          });
        }
      }

      setLoading(false);
    })();
  }, [supabase, searchParams]);

  
  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <DealerNav />
      <main className="flex-1 p-6 pt-28 relative z-0">
        {loading ? (
          <p className="text-gray-500">{t("dealer.loading")}</p>
        ) : dealer ? (
          <>
            {/* âœ… Händlerinfo + Verlauf: Desktop unverändert, Mobile verbessert */}
            <div className="flex flex-col lg:flex-row gap-6 mb-6">
              {/* Händler-Info */}
              <div className="flex-1 min-w-[320px]">
                <div className="h-full flex flex-col bg-white border border-gray-200 rounded-lg shadow-sm p-3 text-[14px] leading-snug">
                  <h2 className="text-base font-semibold mb-2">
                    {t("dealer.infoTitle")}
                  </h2>
                  <div className="space-y-1 flex-1">
                    {dealer.store_name && (
                      <p>
                        <strong>{t("dealer.shop")}:</strong> {dealer.store_name}
                      </p>
                    )}
                    {dealer.company_name && (
                      <p>
                        <strong>{t("dealer.company")}:</strong>{" "}
                        {dealer.company_name}
                      </p>
                    )}
                    {dealer.address && (
                      <p>
                        <strong>{t("dealer.address")}:</strong> {dealer.address}
                      </p>
                    )}
                    {(dealer.zip || dealer.city) && (
                      <p>
                        <strong>{t("dealer.city")}:</strong>{" "}
                        {dealer.zip ?? ""} {dealer.city ?? ""}
                      </p>
                    )}
                    {dealer.email && (
                      <p>
                        <strong>{t("dealer.email")}:</strong> {dealer.email}
                      </p>
                    )}
                    {dealer.phone && (
                      <p>
                        <strong>{t("dealer.phone")}:</strong> {dealer.phone}
                      </p>
                    )}
                  </div>
                </div>
              </div>

              {/* âœ… Letzte Aktivitäten */}
              <div className="w-full lg:max-w-[520px]">
                <div className="h-full flex flex-col gap-4">
                  {pathname.includes("/bestellung") && (
                    <RecentActivityPanel
                      dealerId={dealer.dealer_id}
                      formType="bestellung"
                      limit={2}
                      excelLast={100}
                    />
                  )}
                  {pathname.includes("/sofortrabatt") && (
                    <RecentActivityPanel
                      dealerId={dealer.dealer_id}
                      formType="sofortrabatt"
                      limit={2}
                      excelLast={100}
                    />
                  )}
                  {pathname.includes("/projekt") && (
                    <RecentActivityPanel
                      dealerId={dealer.dealer_id}
                      formType="projekt"
                      limit={2}
                      excelLast={100}
                    />
                  )}
                  {pathname.includes("/support") && (
                    <RecentActivityPanel
                      dealerId={dealer.dealer_id}
                      formType="support"
                      limit={2}
                      excelLast={100}
                    />
                  )}
                  {pathname.includes("/verkauf") && (
                    <RecentActivityPanel
                      dealerId={dealer.dealer_id}
                      formType="verkauf"
                      limit={2}
                      excelLast={100}
                    />
                  )}
                </div>
              </div>
            </div>

            {/* Untere Inhalte */}
            {children}
          </>
        ) : (
          <p className="text-red-500">{t("dealer.notfound")}</p>
        )}
      </main>
    </div>
  );

}

export default function DealerLayout({ children }: { children: ReactNode }) {
  return (
    <I18nProvider>
      <ThemeProvider>
        <DealerProvider>
          <DealerContent>{children}</DealerContent>
        </DealerProvider>
      </ThemeProvider>
    </I18nProvider>
  );
}


